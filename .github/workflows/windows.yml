name: CI on windows

on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches:
    - gha-1
    tags:
    - '*'

jobs:
  windows:
    runs-on: windows-2016
    strategy:
      matrix:
        pattern: [0]
    steps:
    - uses: actions/checkout@v1
    - name: Setup Python environment
      uses: actions/setup-python@v1.1.1
      with:
    # Version range or exact version of a Python version to use, using semvers version range syntax.
        python-version: 3.x
    # The target architecture (x86, x64) of the Python interpreter.
        architecture: x64
    - name: found openssl
      shell: cmd
      run: |
        for /r c:\ %i in (libssl.*lib,libcrypto.*lib) do echo %i
    - name: build and test
      env:
        OPENSSL_USE_STATIC_LIBS: TRUE
        OPENSSL_ROOT: 'C:\Program Files\OpenSSL'
        OPENSSL_ROOT_DIR: 'C:\Program Files\OpenSSL'
        MPATH: C:\Program Files\Git\mingw64\bin
        EVENT_TESTS_PARALLEL: 1
        EVENT_BUILD_PARALLEL: 10  
      shell: powershell
      run: |
        ls $env:OPENSSL_ROOT
        ls -R $env:OPENSSL_ROOT\lib
        # matrix config
        if (${{ matrix.pattern }} -eq 0) {
          $env:EVENT_BUILD_METHOD="cmake"
          $env:EVENT_CMAKE_OPTIONS=""
          $env:APPVEYOR_BUILD_WORKER_IMAGE="Visual Studio 2019"
          echo $env:APPVEYOR_BUILD_WORKER_IMAGE
          $env:JOBS=1         
        }
        # build and test
          $env:PATH="$env:OPENSSL_ROOT\bin;$env:PATH"
          echo ************************
          echo $env:PATH
          echo $env:APPVEYOR_BUILD_WORKER_IMAGE
          echo "OPENSSL_ROOT\bin:$env:OPENSSL_ROOT\bin"
          echo "OPENSSL_ROOT_DIR:$env:OPENSSL_ROOT_DIR"
          echo "OPENSSL_CRYPTO_LIBRARY:$env:OPENSSL_CRYPTO_LIBRARY"
          md build
          cd build
          if ($LastExitCode -ne 0) { $host.SetShouldExit($LastExitCode)  }
          cmake -G 'Visual Studio 15 2017 Win64' .. $env:EVENT_CMAKE_OPTIONS  
          if ($LastExitCode -ne 0) { $host.SetShouldExit($LastExitCode)  }  
          cmake --build . -j $env:EVENT_BUILD_PARALLEL -- /nologo /verbosity:minimal
          if ($LastExitCode -ne 0) { $host.SetShouldExit($LastExitCode)  }
          ctest --output-on-failure -j $env:EVENT_TESTS_PARALLEL      
